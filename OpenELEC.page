Icon="OpenELEC.png"
Menu="unVMs"
Title="OpenELEC"
Type="xmenu"
---
<?PHP

// CREATE HELP CONTENTS
$help_gpu = <<<EOT
Select the graphics card device you wish to use with your OpenELEC VM.  Presently we only support AMD and nVIDIA GPUs and the exact list of supported devices is still growing.  We do not support the assignment of on-board graphics at this time.
EOT;

$help_audio = <<<EOT
Select the sound card device you wish to use with your OpenELEC VM.  For most GPUs, audio can be done through HDMI or with a DVI to HDMI adapter.  For those wishing to use their on-board audio as opposed to their HDMI audio, select device 00:1b.0, if available.
EOT;

$help_usb = <<<EOT
Select the USB devices you wish to use inside your OpenELEC VM.  We have hidden your unRAID USB Flash Device for your protection.  Not all USB devices work for this yet.
EOT;

$help_mac = <<<EOT
You do not need to modify this field unless you wish to control the exact MAC address that unRAID should use for this OpenELEC virtual machine.
EOT;

$help_readonly = <<<EOT
Check this option to prevent OpenELEC write access to your unRAID array.
EOT;

$help_readonly = <<<EOT
Check this option to prevent OpenELEC write access to your unRAID array.
EOT;

$help_startvm = <<<EOT
Starting the VM will apply the settings you have specified above as well as bind your GPU/audio devices to the vfio-pci driver.
EOT;

$help_stopvm = <<<EOT
Click this button to stop OpenELEC.
EOT;

$help_forcevm = <<<EOT
Click this button to force OpenELEC to shutdown immediately (use if VM is stuck in hung state).
EOT;

$boolInstalled = file_exists("/mnt/user/vms/kvm/OpenELEC/OpenELEC-4.2.1-1_LT.img");
$boolRunning = (shell_exec("virsh list | grep OpenELEC") != "");
$boolACSEnabled = (strpos(file_get_contents('/proc/cmdline'), 'pcie_acs_override=') !== false);

?>

<script>
	function launch(form) {
		var width    = ((screen.width*2)/3)||0;
		var height   = ((screen.height*2)/3)||0;
		var features = "resizeable=yes,scrollbars=yes,width=" + width + ",height=" + height;
		var myWindow = window.open('', form.target, features);
		myWindow.focus();
		form.submit();
		parent.location = parent.location;
	}
</script>

<?php

if (!$boolInstalled) {
	?><span class="red"><b>OpenELEC is NOT INSTALLED</b></span><?php
} else if (!$boolRunning) {
	?><span class="red"><b>OpenELEC is NOT RUNNING</b></span><?php
} else {
	?><span class="green"><b>OpenELEC is RUNNING</b></span><?php
}


// DOWNLOAD & UNTAR VDISK IF NECESSARY
if (!$boolInstalled) { ?>
<form method="POST" action="/logging.htm" target="OpenELEC">
	<input type="hidden" name="title" value="OpenELEC VM Download">
	<input type="hidden" name="cmd" value="/usr/local/emhttp/plugins/OpenELEC/event/disks_mounted">
	<button type="button" onclick="launch(this.form);">Download VM</button>
</form>

<?php
return;
}

// Check for PCIE ACS capabilities
if (!$boolACSEnabled) {
	// Check the /boot/syslinux/syslinux.cfg for the existance of pcie_acs_override=downstream, add it in if not found
	$arrSyslinuxCfg = file('/boot/syslinux/syslinux.cfg');
	$strCurrentLabel = '';
	$boolModded = false;
	foreach ($arrSyslinuxCfg as &$strSyslinuxCfg) {
		if (stripos(trim($strSyslinuxCfg), 'label ') === 0) {
			$strCurrentLabel = trim(str_ireplace('label ', '', $strSyslinuxCfg));
		}
		if (stripos($strSyslinuxCfg, 'append ') !== false) {
			if (stripos($strSyslinuxCfg, 'pcie_acs_override=') === false) {
				// pcie_acs_override=downstream was not found so append it in
				$strSyslinuxCfg = str_ireplace('append ', 'append pcie_acs_override=downstream ', $strSyslinuxCfg);
				$boolModded = true;
			}

			// We just modify the first append line, other boot menu items are untouched
			break;
		}
	}

	if ($boolModded) {
		// Backup syslinux.cfg
		copy('/boot/syslinux/syslinux.cfg', '/boot/syslinux/syslinux.cfg-');

		// Write Changes to syslinux.cfg
		file_put_contents('/boot/syslinux/syslinux.cfg', implode('', $arrSyslinuxCfg));
	}
?>
<p class="notice">You must reboot in to <b><?=$strCurrentLabel?></b> mode for changes to take effect for OpenELEC to operate</p>

<?php
return;
}

// MAKE SURE THE VM ISN'T RUNNING
if ($boolRunning) { ?>
<form target="progressFrame" action="/plugins/webGui/exec.php" method="POST">
	<input type="hidden" name="command" value="virsh shutdown OpenELEC &amp;&amp; i=0; while [ $(virsh list | grep OpenELEC | wc -l) -gt &quot;0&quot; -a &quot;$i&quot; -le &quot;30&quot; ]; do i=`expr $i + 1`; sleep 1; done"/>
	<input type="submit" value="Stop VM"/>
</form>

<!-- HELP FOR STOP VM -->
<blockquote class="inline_help">
<?php echo Markdown($help_stopvm); ?>
</blockquote>

<form target="progressFrame" action="/plugins/webGui/exec.php" method="POST">
	<input type="hidden" name="command" value="virsh destroy OpenELEC &amp;&amp; i=0; while [ $(virsh list | grep OpenELEC | wc -l) -gt &quot;0&quot; -a &quot;$i&quot; -le &quot;30&quot; ]; do i=`expr $i + 1`; sleep 1; done"/>
	<input type="submit" value="Force Shutdown VM"/>
</form>

<!-- HELP FOR FORCE STOP VM -->
<blockquote class="inline_help">
<?php echo Markdown($help_forcevm); ?>
</blockquote>

<?php
return;
}


// CREATE ARRAY OF GPU/AUDIO DEVICES
$arrWhitelistGPUNames = array('VGA compatible controller');
$arrWhitelistAudioNames = array('Audio device');
$arrValidGPUDevices = array();
$arrValidAudioDevices = array();
exec("lspci", $arrAllPCIDevices);
foreach ($arrAllPCIDevices as $strPCIDevice) {
	if (preg_match('/^(?P<id>\S+) (?P<type>.+): (?P<name>.+)$/', $strPCIDevice, $arrMatch)) {
		if (in_array($arrMatch['type'], $arrWhitelistGPUNames)) {
			$arrName = 'arrValidGPUDevices';
		} else if (in_array($arrMatch['type'], $arrWhitelistAudioNames)) {
			$arrName = 'arrValidAudioDevices';
		} else {
			// Not in either whitelist, skip device
			continue;
		}

		if (!file_exists('/sys/bus/pci/devices/0000:' . $arrMatch['id'] . '/iommu_group/')) {
			// No IOMMU support for device, skip device
			continue;
		}

		${$arrName}[] = array(
			'dev_id' => $arrMatch['id'],
			'dev_type' => $arrMatch['type'],
			'dev_name' => $arrMatch['name']
		);
	}
}

// Check for available video devices, one is required
if (empty($arrValidGPUDevices)) {
?>
<p class="notice">This VM requires a valid graphics device and hardware capable of Intel VT-d or AMD Vi.  If you think you are receiving this message in error, please check your BIOS settings.</p>

<?php
return;
}

// CREATE ARRAY OF USB DEVICES
$arrBlacklistUSBNames = array('/.* root hub$/', '/^Intel Corp.$/');
$arrValidUSBDevices = array();
exec("lsusb", $arrAllUSBDevices);
foreach ($arrAllUSBDevices as $strUSBDevice) {
	if (preg_match('/^.+ID (?P<id>\S+) (?P<name>.+)$/', $strUSBDevice, $arrMatch)) {
		$arrMatch['name'] = trim($arrMatch['name']);

		if (empty($arrMatch['name'])) {
			// Device name is blank, skip device
			continue;
		}

		foreach ($arrBlacklistUSBNames as $strBlacklistUSBName) {
			if (preg_match($strBlacklistUSBName, $arrMatch['name'])) {
				// Device name matches a blacklist item, skip device
				continue 2;
			}
		}

		if (stripos($GLOBALS['var']['flashGUID'], str_replace(':', '-', $arrMatch['id'])) === 0) {
			// Device id matches the unraid device, skip device
			continue;
		}

		$arrValidUSBDevices[] = array(
			'dev_id' => $arrMatch['id'],
			'dev_name' => $arrMatch['name'],
		);
	}
}

?>


<!-- FORM START -->
<form action="/plugins/OpenELEC/OpenELEC-submit.php" method="POST" target="progressFrame">
	<dl>

		<!-- ENUMERATE OPTIONS FOR VIDEO SELECTION -->
		<dt>Graphics Card:</dt>
		<dd>
		<?php if (!empty($arrValidGPUDevices)) { ?>
			<select name="gpu">
			<?php foreach($arrValidGPUDevices as $x) { ?>
				<option value="<?php echo $x['dev_id'] ?>"><?php echo $x['dev_id'] ?> | <?php echo $x['dev_name'] ?></option>
			<?php } ?>
			</select>
		<?php } else { ?>
			<input type="hidden" name="gpu" value="">
			<i>None available</i>
		<?php } ?>

			<!-- HELP FOR VIDEO DEVICES -->
			<blockquote class="inline_help">
			<?php echo Markdown($help_gpu); ?>
			</blockquote>
		</dd>

		<!-- ENUMERATE OPTIONS FOR AUDIO SELECTION -->
		<dt>Sound Card:</dt>
		<dd>
		<?php if (!empty($arrValidAudioDevices)) { ?>
			<select name="audio">
			<?php foreach($arrValidAudioDevices as $x) { ?>
				<option value="<?php echo $x['dev_id'] ?>"><?php echo $x['dev_id'] ?> | <?php echo $x['dev_name'] ?></option>
			<?php } ?>
			</select>
		<?php } else { ?>
			<input type="hidden" name="audio" value="">
			<i>None available</i>
		<?php } ?>

			<!-- HELP FOR AUDIO DEVICES -->
			<blockquote class="inline_help">
			<?php echo Markdown($help_audio); ?>
			</blockquote>
		</dd>

		<!-- ENUMERATE OPTIONS FOR USB SELECTION -->
		<dt>USB Devices:</dt>
		<dd>
		<?php if (!empty($arrValidUSBDevices)) {
				$y=0;
				foreach($arrValidUSBDevices as $x) { ?>
				<input type="checkbox" name="usb[]" id="usb<?php echo ++$y ?>" value="<?php echo $x['dev_id'] ?>"> <label for="usb<?php echo $y ?>"><?php echo $x['dev_id'] ?> | <?php echo $x['dev_name'] ?></label><br/>
			<?php }
		} else { ?>
			<input type="hidden" name="usb[]" value="">
			<i>None available</i>
		<?php } ?>

			<!-- HELP FOR USB DEVICES -->
			<blockquote class="inline_help">
			<?php echo Markdown($help_usb); ?>
			</blockquote>
		</dd>

		<!-- MAC ADDRESS SPECIFICATION -->
		<dt>MAC Address:</dt>
		<dd>
			<input type="text" name="mac" value="52:54:00:xx:xx:xx"/>

		<!-- HELP FOR MAC ADDRESS -->
			<blockquote class="inline_help">
			<?php echo Markdown($help_mac); ?>
			</blockquote>
		</dd>

		<!-- UNRAID BRIDGE GLOBAL VARIABLE PASS -->
		<input type="hidden" name="bridge" value="<?php echo $GLOBALS['var']['BRNAME'] ?>"/>

		<!-- READONLY MODE FOR USER SHARE -->
		<dt>Media Readonly:</dt>
		<dd>
			<input type="checkbox" name="readonly" id="readonly" value="1" checked="checked"> <label for="readonly">Prevent OpenELEC write access to your media files</label>

			<!-- HELP FOR MEDIA READ-ONLY -->
			<blockquote class="inline_help">
			<?php echo Markdown($help_readonly); ?>
			</blockquote>
		</dd>

		<!-- START AND STOP VM -->
		<dt></dt>
		<dd>
			<input type="submit" value="Start VM"/>

			<!-- BLOCKQUOTE FOR RENDERING INLINE HELP -->
			<blockquote class="inline_help">
			<?php echo Markdown($help_startvm); ?>
			</blockquote>
		</dd>

	</dl>
</form>
